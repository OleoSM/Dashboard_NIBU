<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard NIBU</title>
  <!-- LIBRER√çAS EXTERNAS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- LIBRER√çA PARA CAPTURA DE PANTALLA -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- LIBRER√çA PARA GENERAR PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
:root{
  --primary:#C3002F;
  --primary-dark:#8A0020;
  --accent:#D71A28;
  --ok:#4CAF50;
  --warn:#FFC107;
  --bad:#F44336;
  --bg:#F4F4F4;
  --card:#FFFFFF;
  --table-head:#1a1a1a;
  --muted:#FAFAFA;
  --text:#111111;
  --border-radius-card: 16px;
  --border-radius-btn: 10px;
  --card-shadow: 0 2px 6px rgba(0,0,0,0.08);
  --card-shadow-hover: 0 4px 12px rgba(0,0,0,0.12);
}

*{
  box-sizing:border-box;
}

html,body{
  height:100%;
}

.brand-header {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 16px;
  margin-top: 10px;
  background: #fff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.header-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

.nibu-logo {
  height: 50px;
  max-width: 150px;
  width: auto;
  object-fit: contain;
  transition: transform 0.3s ease;
}

.nibu-logo:hover {
  transform: scale(1.05);
}

.view-toggle-btn {
    background: #2E2E2E;
    color: white;
    border: 2px solid #2E2E2E;
    padding: 8px 16px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}
.view-toggle-btn:hover {
    background: #000;
    transform: translateY(-2px);
}

/* BOTON SEMAFORO */
.traffic-btn {
    background: #f0f0f0;
    color: #333;
    border: 2px solid #ccc;
}
.traffic-btn.active {
    background: #fff3e0;
    color: #e65100;
    border-color: #ff9800;
}
.traffic-btn:hover {
    background: #e0e0e0;
}

/* Bot√≥n espec√≠fico para Screenshot */
.screenshot-btn {
    background: #1976D2;
    border-color: #1976D2;
}
.screenshot-btn:hover {
    background: #115293;
}

/* ESTILO PARA BOT√ìN DESHABILITADO */
.screenshot-btn:disabled, button:disabled {
    background-color: #ccc !important;
    border-color: #999 !important;
    color: #666 !important;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

.view-label {
    font-size: 12px;
    background: var(--primary);
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
}

@media (max-width: 768px) {
  .nibu-logo {
    height: 40px;
    max-width: 120px;
  }
  
  /* Ocultar bot√≥n de captura en m√≥viles */
  .screenshot-btn {
      display: none !important;
  }
}

@media (max-width: 480px) {
  .brand-header {
    flex-direction: column;
    gap: 10px;
    padding: 8px;
  }
  .nibu-logo {
    height: 36px;
    max-width: 110px;
  }
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  color: var(--text);
  background-color: #f8f9fa;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1{
  color:#003366;
  margin: 16px 0 8px;
  font-size: clamp(20px, 3.2vw, 28px);
  text-align:center;
}

.separacion{
  display:none;
  justify-content:center;
  align-items:center;
  background:#ffffff;
  border-left:6px solid var(--primary);
  color:var(--primary-dark);
  padding:12px 0;
  margin-top:24px;
  border-radius:var(--border-radius-btn);
  box-shadow:var(--card-shadow);
}

.instructions-box{
  background: #ffffff;
  border: 1px solid #e5e7eb;
  border-radius: var(--border-radius-card);
  padding: 0;
  margin: 20px auto;
  max-width: 900px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.06);
  overflow: hidden;
  animation: fadeIn 0.5s ease-out;
}

.instructions-header{
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  padding: 24px 32px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.instructions-icon{
  width: 32px;
  height: 32px;
  flex-shrink: 0;
}

.instructions-header h2{
  color: white;
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  border: none;
  padding: 0;
  text-align: left;
}

.instructions-content{
  padding: 32px;
}

.instructions-grid{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.instruction-step{
  display: flex;
  gap: 16px;
  align-items: flex-start;
}

.step-number{
  background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 18px;
  flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,82,204,0.3);
}

.step-content h3{
  color: var(--primary-dark);
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 6px 0;
}

.step-content p{
  color: #6b7280;
  font-size: 14px;
  line-height: 1.5;
  margin: 0;
}

.instructions-footer{
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.footer-icon{
  width: 24px;
  height: 24px;
  color: var(--primary);
  flex-shrink: 0;
}

.instructions-footer p{
  margin: 0;
  font-size: 14px;
  color: #374151;
  line-height: 1.5;
}

.separacion h1{
  margin:0;
  font-size:1.6em;
  letter-spacing:0.5px;
}

.wrapper{
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 16px 24px;
}

.controls{
  display:flex;
  flex-wrap: wrap;
  gap:12px;
  align-items:center;
  justify-content:center;
  margin: 8px 0 12px;
  background: #f8f8f8;
  padding: 15px;
  border-radius: 12px;
}

button{
  background: var(--primary);
  color:#fff;
  border:0;
  padding:10px 16px;
  border-radius:var(--border-radius-btn);
  cursor:pointer;
  transition: all .3s ease;
  font-weight:600;
  font-size: 14px;
  box-shadow: 0 2px 8px rgba(195,0,47,0.25);
}

button:hover{ 
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(195,0,47,0.3);
}

button:active{
  transform: translateY(0);
}

select,input[type="file"],input[type="text"]{
  padding:8px 10px;
  border-radius:var(--border-radius-btn);
  border:1px solid #d1d5db;
  background:#fff;
  max-width:100%;
  font-size: 14px;
  transition: border-color .2s ease;
}

select:focus, input[type="file"]:focus, input[type="text"]:focus{
  outline: none;
  border-color: var(--primary);
}

select{
  font-weight: 600;
  color: var(--primary-dark);
}

#status, #status_V2{
  text-align:center;
  min-height: 22px;
  font-weight:600;
  margin-top: 8px;
  white-space: pre-line;
}

.error{ 
  color:#b71c1c; 
}

.section{
  margin: 18px 0;
}

.scroller{
  display:flex;
  gap:16px;
  overflow-x:auto;
  padding-bottom:10px;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x proximity;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) #e5e7eb;
}

.scroller::-webkit-scrollbar {
  height: 8px;
}

.scroller::-webkit-scrollbar-track {
  background: #e5e7eb;
  border-radius: 4px;
}

.scroller::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

.scroller::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

.card{
  background: var(--card);
  border-radius: var(--border-radius-card);
  box-shadow: var(--card-shadow);
  padding: 20px;
  scroll-snap-align: start;
  transition: all .3s ease;
  display: flex;
  flex-direction: column;
  gap: 12px;
  border-top: 10px solid var(--primary);
  flex: 0 0 300px;
  min-width: 300px;
  max-width: 300px;
  width: 300px;
}

.card:hover{
  box-shadow: var(--card-shadow-hover);
  transform: translateY(-2px);
}

.card canvas{
  width: 100% !important;
  max-width: 300px !important;
  height: auto !important;
  margin: 0 auto;
}

.card p{
  margin: 8px 0;
  font-size: 14px;
  color: var(--text);
  text-align: center;
}

.card p strong{
  font-weight: 700;
}

.card p span[id$="TargetLabel"], .card p span[id$="TargetLabel_V2"]{
  font-weight: 600;
  color: var(--primary-dark);
}

.tables{
  display:grid;
  gap:16px;
  grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
}

.tables-container{
  display: grid;
  grid-template-columns: repeat(3, 1fr);
}

/* ====== ESTILOS MEJORADOS PARA TABLAS ====== */

.table-container{ 
  background: #ffffff;
  border-radius: var(--border-radius-card);
  box-shadow: var(--card-shadow);
  padding: 0;
  transition: all .3s ease;
  overflow: hidden; 
  border: 1px solid #e5e7eb;
}

/* --- CORRECCI√ìN PARA TABLA NRC DENTRO DEL SCROLLER --- */
.scroller .table-container {
  flex: 0 0 300px;
  min-width: 300px;
  max-width: 300px;
  width: 300px;
  height: fit-content; 
}

.table-container:hover{
  box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  transform: translateY(-3px);
  border-color: var(--primary);
}

table{ 
  width:100%; 
  border-collapse: collapse;
  font-size: 14px;
}

th{
  background: var(--table-head);
  color: #ffffff;
  padding: 14px 12px;
  text-align: center;
  font-weight: 600;
  font-size: 14px;
  letter-spacing: 0.5px;
    
}

.subheader td{
  background: #f3f4f6;
  color: #4b5563;
  font-weight: 700;
  font-size: 12px;
    
  letter-spacing: 0.8px;
  padding: 10px;
  border-bottom: 1px solid #e5e7eb;
}

td{
  text-align: center;
  border-top: 1px solid #f3f4f6;
  padding: 14px 10px;
  color: #374151;
  font-size: 13px;
  font-weight: 500;
}

tbody tr:nth-child(even) {
    background-color: #fafafa;
}

tbody tr:hover {
    background-color: #fef2f2;
}

/* NUEVOS ESTILOS PARA MINI GAUGE EN TABLA NRC */
.mini-gauge-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    position: relative;
    height: 40px;
}

.mini-gauge-container canvas {
    width: 35px !important;
    height: 35px !important;
}

.mini-gauge-text {
    font-size: 12px;
    font-weight: 700;
}

/* Ajuste de padding de celda para que quepa la mini gr√°fica */
#nrcTableCard tbody td, #nrcTableCard_V2 tbody td {
    padding: 8px 10px;
}

/* Styling for the GamePlan Quarter Bar */
.quarter-bar-container {
    width: 80%;
    height: 18px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin: 4px auto;
    display: flex;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
}

.quarter-segment {
    height: 100%;
    display: inline-block;
    transition: width 0.5s ease-out;
}

.quarter-fill-v1, .quarter-fill-v2 {
    background-color: #105cd4;
}

.quarter-label {
    font-weight: 700;
    font-size: 12px;
    margin-top: 4px;
    color: #105cd4;
}


/* ====== MEDIA QUERIES AJUSTADOS PARA TABLA EN SCROLLER ====== */
@media (max-width: 1024px){
  .card, #totalChartCard, #trainingCombinedBarChartCard,
  #totalChartCard_V2, 
  .scroller .table-container {
    flex: 0 0 300px !important;
    min-width: 300px !important;
    max-width: 300px !important;
    width: 300px !important;
  }
}

@media (max-width: 768px){
  .card, #totalChartCard, #trainingCombinedBarChartCard,
  #totalChartCard_V2,
  .scroller .table-container { 
    flex: 0 0 280px !important;
    min-width: 280px !important;
    max-width: 280px !important;
    width: 280px !important;
    padding: 16px; 
  }
  .table-container{ 
    padding: 0; 
  }
}

@media (max-width: 640px){
  .card, #totalChartCard, #trainingCombinedBarChartCard,
  #totalChartCard_V2,
  .scroller .table-container { 
    flex: 0 0 260px !important;
    min-width: 260px !important;
    max-width: 260px !important;
    width: 260px !important;
  }
  .tables-container{
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    grid-template-rows: repeat(2, 1fr);
    overflow: auto;
  }
    
  .card canvas {
    max-width: 260px !important;
  }
    
  button{ 
    padding: 9px 14px;
    font-size: 13px;
  }
    
  .controls{
    gap: 8px;
  }
    
  h1{
    font-size: 20px;
  }
    
  #totalChartCard::after, #totalChartCard_V2::after{
    animation-duration: 8s;
  }
    
  #totalInfo strong, #totalInfo_V2 strong{
    font-size: 20px;
  }
}

@media (max-width: 480px){
  .wrapper{
    padding: 0 12px 20px;
  }
    
  .card, #totalChartCard, #trainingCombinedBarChartCard,
  #totalChartCard_V2,
  .scroller .table-container {
    flex: 0 0 240px !important;
    min-width: 240px !important;
    max-width: 240px !important;
    width: 240px !important;
  }
    
  .card canvas {
    max-width: 240px !important;
  }
    
  .scroller{
    gap: 12px;
  }
}

@media (max-width: 360px){
  .card, #totalChartCard, #trainingCombinedBarChartCard,
  #totalChartCard_V2,
  .scroller .table-container {
    flex: 0 0 220px !important;
    min-width: 220px !important;
    max-width: 220px !important;
    width: 220px !important;
    padding: 10px;
  }
}

.hint{ 
  color:#6b7280; 
  font-size:12px; 
  text-align:center; 
  margin-top:6px;
  font-style: italic;
}

#debugInfo, #debugInfo_V2{
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: var(--border-radius-btn);
  padding: 16px;
  margin-top: 20px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: #374151;
  max-height: 300px;
  overflow-y: auto;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card, .table-container{
  animation: fadeIn 0.3s ease-out;
}

.hidden{
  display: none !important;
}

.text-center{
  text-align: center;
}

.dual-section-container {
  display: flex;
  flex-direction: column;
  gap: 16px;
  margin-top: 12px;
}

.graficas{
  display: flex;
  flex-direction: row;
  gap: 16px;
  overflow: auto;
  padding: 12px 0;
}

.section-block {
  background: none;
  overflow: hidden;
}

.section-block .section {
  margin: 0;
}

/* --- LAYOUTS SCROLLERS --- */

.section-block .scroller {
  display: flex;
  gap: 16px;
  overflow-x: auto;
  padding-bottom: 10px;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x proximity;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) #e5e7eb;
}

.section-block .scroller::-webkit-scrollbar {
  height: 8px;
}

.section-block .scroller::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

.section-block .scroller::-webkit-scrollbar-thumb:hover {
  background: var(--primary-dark);
}

.section-block .card {
  scroll-snap-align: start;
  flex: 0 0 auto;
}

#totalChartCard, #totalChartCard_V2{
  position: relative;
  overflow: hidden;
  background: linear-gradient(135deg, #ffffff 0%, #fffbf0 100%);
  border: 2px solid #ffd700;
  box-shadow: 
    0 4px 16px rgba(255, 215, 0, 0.15),
    0 0 20px rgba(255, 215, 0, 0.1);
  transition: all 0.3s ease;
  flex: 0 0 300px;
  min-width: 300px;
  max-width: 300px;
  width: 300px;
}

#totalChartCard::before, #totalChartCard_V2::before{
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(90deg, #ffd700, #ffed4e, #ffd700);
  background-size: 200% 200%;
  border-radius: var(--border-radius-card);
  z-index: -1;
  opacity: 0.6;
  animation: gentleGradient 4s ease infinite;
}

#totalChartCard::after, #totalChartCard_V2::after{
  content: '';
  position: absolute;
  top: -50%;
  left: -100%;
  width: 50%;
  height: 200%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
  transform: skewX(-20deg);
  animation: gentleShine 6s ease-in-out infinite;
}

#totalChartCard canvas, #totalChartCard_V2 canvas{
  position: relative;
  z-index: 1;
}

#totalChartCard p, #totalChartCard_V2 p{
  position: relative;
  z-index: 1;
  font-weight: 600;
}

#totalInfo strong, #totalInfo_V2 strong{
  font-size: 24px;
  color: #b8860b;
  text-shadow: 0 1px 2px rgba(255, 215, 0, 0.3);
}

#totalChartCard:hover, #totalChartCard_V2:hover{
  transform: translateY(-3px);
  box-shadow: 
    0 6px 24px rgba(255, 215, 0, 0.25),
    0 0 30px rgba(255, 215, 0, 0.15);
}

@keyframes gentleGradient {
  0%, 100% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
}

@keyframes gentleShine {
  0% {
    left: -100%;
  }
  50%, 100% {
    left: 150%;
  }
}

#trainingCombinedBarChartCard {
  flex: 0 0 340px;
  min-width: 340px;
  max-width: 380px;
  width: 100%;
  height: auto;
}

#trainingCombinedBarChartCard canvas {
  width: 100% !important;
  height: 360px !important; 
  max-width: 400px !important;
  aspect-ratio: 4 / 3;
}

.graficas-scroll {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  overflow-x: auto;
  gap: 20px;
  scroll-snap-type: x mandatory;
}

.subgrupo {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  scroll-snap-align: start;
}

.graficas-linea {
  display: flex;
  flex-direction: row;
  gap: 16px;
}

.titulo-grupo {
  width: 100%;
  background: #fff;
  border-left: 6px solid var(--primary);
  color: var(--primary-dark);
  text-align: center;
  padding: 10px 0;
  border-radius: var(--border-radius-btn);
  box-shadow: var(--card-shadow);
  margin-bottom: 10px;
}

.titulo-grupo h1 {
  margin: 0;
  font-size: 1.6em;
  letter-spacing: 0.5px;
}

/* =========================================================================
   ESTILOS OPTIMIZADOS PARA MODO CAPTURA (FULL VIEW HD - FIXED LAYOUT)
   ========================================================================= */
body.screenshot-mode {
    background-color: #ffffff;
    overflow-y: auto !important; 
    overflow-x: hidden !important;
    height: auto !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
}

body.screenshot-mode .wrapper {
    width: 1200px !important;
    max-width: 1200px !important; 
    margin: 0 auto !important;
    padding: 20px 30px !important;
    background: white;
    box-sizing: border-box;
    overflow: visible !important;
}

/* Ocultar elementos innecesarios */
body.screenshot-mode .brand-header,
body.screenshot-mode .controls,
body.screenshot-mode .instructions-box,
body.screenshot-mode #status,
body.screenshot-mode #status_V2 {
    display: none !important;
}

/* FIX: Desactivar animaciones y scrollbars */
body.screenshot-mode *,
body.screenshot-mode *:before,
body.screenshot-mode *:after {
    animation: none !important;
    transition: none !important;
}

body.screenshot-mode .scroller,
body.screenshot-mode .graficas-scroll,
body.screenshot-mode .section-block .scroller {
    overflow: visible !important;
    -webkit-overflow-scrolling: auto !important;
    padding: 0 !important; /* Eliminar padding que causa overflow */
    margin: 0 !important;
}

body.screenshot-mode .scroller::-webkit-scrollbar,
body.screenshot-mode .graficas-scroll::-webkit-scrollbar {
    display: none !important;
}

/* =========================================================================
   UNIFORMIDAD DE TAMA√ëOS Y ESTILOS EN MODO CAPTURA
   ========================================================================= */

/* 1. BRAND POWER (Tablas): Ajuste autom√°tico */
body.screenshot-mode .table-container {
    min-height: auto !important; 
    height: auto !important;     
    display: block !important;
    margin-bottom: 0 !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 12px !important;
    background: white !important;
    padding: 0 !important; 
}

/* 2. GENERAL CARD STYLES IN SCREENSHOT */
body.screenshot-mode .card,
body.screenshot-mode #trainingCombinedBarChartCard {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
    border: 1px solid #e0e0e0 !important;
    border-radius: 12px !important;
    background: white !important;
    /* IMPORTANT: Reset flex/width constraints from base CSS */
    flex: unset !important;
    min-width: 0 !important; 
    max-width: unset !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 10px 12px !important; /* Reducido para evitar desbordamiento */
}

/* 3. ROW 1: CUSTOMER EXPERIENCE (3 Columns) */
body.screenshot-mode #chartsRow1,
body.screenshot-mode #chartsRow1_V2 {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
    overflow: visible !important;
    padding: 0 !important;
    margin-bottom: 20px !important;
}

/* Height specific for Row 1 cards to look uniform */
body.screenshot-mode #chartsRow1 .card,
body.screenshot-mode #chartsRow1_V2 .card {
    height: auto !important;
    min-height: 280px !important;
    max-height: 300px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 14px 16px !important;
    gap: 8px !important;
}

/* Training Chart Card - altura espec√≠fica */
body.screenshot-mode #trainingCombinedBarChartCard {
    height: auto !important;
    min-height: 280px !important;
    max-height: 300px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    padding: 14px 16px !important;
}

/* 4. ROW 2: BRAND POWER (Tables) - 3 Columns */
body.screenshot-mode .tables-container {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
    overflow: visible !important;
    margin-bottom: 20px !important;
    padding: 0 !important;
}

/* 5. ROW 3: SUSTAINABLE (3 cards) + TOTAL (1 card) */
/* Structure: .graficas-scroll contains 2 .subgrupos */
body.screenshot-mode .graficas-scroll {
    display: grid !important;
    /* 3fr for Sustainable (3 cards), 1fr for Total (1 card) = Equal card widths */
    grid-template-columns: 3fr 1fr !important;
    gap: 16px !important;
    width: 100% !important;
    align-items: start !important;
}

body.screenshot-mode .subgrupo {
    width: 100% !important;
    margin: 0 !important;
}

/* Inner Grid for Sustainable */
body.screenshot-mode .subgrupo:first-child .graficas-linea {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
}

/* Inner Grid for Total */
body.screenshot-mode .subgrupo:last-child .graficas-linea {
    display: block !important;
    width: 100% !important;
}

/* STRICT HEIGHT ENFORCEMENT FOR ROW 3 */
body.screenshot-mode #sellInChartCard,
body.screenshot-mode #retentionChartCard,
body.screenshot-mode #retailChartCard,
body.screenshot-mode #totalChartCard,
body.screenshot-mode #sellInChartCard_V2,
body.screenshot-mode #retentionChartCard_V2,
body.screenshot-mode #retailChartCard_V2,
body.screenshot-mode #totalChartCard_V2 {
    height: auto !important;
    min-height: 280px !important;
    max-height: 300px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 14px 16px !important;
    gap: 8px !important;
}

/* Style specific for Total Card */
body.screenshot-mode #totalChartCard,
body.screenshot-mode #totalChartCard_V2 {
    background: linear-gradient(135deg, #ffffff 0%, #fffbf0 100%) !important;
    border: 2px solid #b8860b !important;
}

/* Canvas Sizing Fixes */
body.screenshot-mode .card > canvas,
body.screenshot-mode #totalChartCard canvas,
body.screenshot-mode #totalChartCard_V2 canvas {
    max-height: 140px !important;
    height: 140px !important;
    width: 100% !important;
    max-width: 180px !important;
    margin: 6px auto !important;
    display: block !important;
}

/* Training Chart Specifics */
body.screenshot-mode #trainingCombinedBarChartCard canvas {
    max-height: 220px !important;
    height: 220px !important;
    width: 100% !important;
    max-width: 100% !important;
    object-fit: contain !important;
}

/* Titles */
body.screenshot-mode .titulo-grupo {
    background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%) !important;
    border-left: 4px solid var(--primary) !important;
    border-radius: 6px !important;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06) !important;
    margin-bottom: 12px !important;
    padding: 8px 16px !important;
}

body.screenshot-mode .titulo-grupo h1 {
    font-size: 16px !important;
    margin: 0 !important;
}

/* Remove decorative elements */
body.screenshot-mode #totalChartCard::before,
body.screenshot-mode #totalChartCard::after,
body.screenshot-mode #totalChartCard_V2::before,
body.screenshot-mode #totalChartCard_V2::after { 
    display: none !important; 
}

/* Font sizes and margins reduced for screenshot mode */
body.screenshot-mode .card p {
    font-size: 12px !important;
    margin: 2px 0 !important;
    text-align: center !important;
    line-height: 1.2 !important;
}
body.screenshot-mode .card p strong {
    font-size: 18px !important;
    display: block !important;
    margin-bottom: 2px !important;
}

/* Tablas con altura uniforme */
body.screenshot-mode .table-container table {
    height: 100% !important;
}

body.screenshot-mode .table-container th {
    font-size: 13px !important;
    padding: 10px 6px !important;
}

body.screenshot-mode .table-container td {
    font-size: 12px !important;
    padding: 8px 6px !important;
}

/* Mini gauge en tabla NRC */
body.screenshot-mode .mini-gauge-container canvas {
    width: 35px !important;
    height: 35px !important;
}

/* Barra de progreso GamePlan uniforme */
body.screenshot-mode .quarter-bar-container {
    height: 16px !important;
    width: 85% !important;
    margin: 5px auto !important;
}

/* ==========================================================================
   LAYOUT DEFAULT (ESCRITORIO/TABLET > 768px) - 3 COLUMNAS
   ==========================================================================
*/
body.screenshot-mode .wrapper {
    width: 1200px !important;
    max-width: 1200px !important; 
    margin: 0 auto !important;
    padding: 20px 30px !important;
    background: white;
    box-sizing: border-box;
    overflow: visible !important;
}

/* T√≠tulos uniformes y profesionales */
body.screenshot-mode h1 {
    font-size: 20px !important;
    margin: 0 0 16px 0 !important;
    text-align: left !important;
    border-bottom: 2px solid var(--primary);
    padding-bottom: 10px;
    font-weight: 600 !important;
    color: #1a1a1a !important;
}

/* --- GRIDS ESCRITORIO CON ESPACIADO UNIFORME --- */

/* Fila 1: Customer Experience (3-5 elementos dependiendo de la vista) */
body.screenshot-mode #chartsRow1 {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
    overflow: visible !important;
    padding: 0 !important;
    margin-bottom: 20px !important;
}

body.screenshot-mode #chartsRow1_V2 {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
    overflow: visible !important;
    padding: 0 !important;
    margin-bottom: 20px !important;
}

/* Fila 2: Brand Power (3 Columnas) */
body.screenshot-mode .tables-container {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
    width: 100% !important;
    overflow: visible !important;
    margin-bottom: 20px !important;
}

/* Fila 3: Sustainable + Total (Layout Complejo) */
body.screenshot-mode .contenedor-total,
body.screenshot-mode .section-block {
    display: block !important;
    width: 100% !important;
    overflow: visible !important;
}

body.screenshot-mode .graficas-scroll {
    display: grid !important;
    grid-template-columns: 3fr 1fr !important;
    gap: 16px !important;
    align-items: start !important;
    overflow: visible !important;
}

body.screenshot-mode .subgrupo:first-child { 
    width: 100% !important; 
}

body.screenshot-mode .subgrupo:first-child .graficas-linea {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 16px !important;
}

body.screenshot-mode .subgrupo:last-child { 
    width: 100% !important; 
    height: 100% !important; 
}

body.screenshot-mode .subgrupo:last-child .graficas-linea {
    display: flex !important;
    flex-direction: column !important;
    height: 100% !important;
}

/* Estilos base para todas las tarjetas (Excepciones ya manejadas arriba) */
body.screenshot-mode .scroller .table-container {
    flex: unset !important;
    width: 100% !important;
    min-width: unset !important;
    max-width: unset !important;
    margin: 0 !important;
    page-break-inside: avoid;
}

/* Eliminar efectos especiales del Total Achievement */
body.screenshot-mode #totalChartCard::before,
body.screenshot-mode #totalChartCard::after,
body.screenshot-mode #totalChartCard_V2::before,
body.screenshot-mode #totalChartCard_V2::after { 
    display: none !important; 
}

/* T√≠tulos de grupo con estilo consistente */
body.screenshot-mode .titulo-grupo {
    background: linear-gradient(135deg, #f8f8f8 0%, #f0f0f0 100%) !important;
    border-left: 4px solid var(--primary) !important;
    border-radius: 6px !important;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06) !important;
    margin-bottom: 12px !important;
    padding: 8px 16px !important;
}

body.screenshot-mode .titulo-grupo h1 {
    font-size: 16px !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    font-weight: 600 !important;
    color: var(--primary-dark) !important;
}

/* Barra de herramientas flotante para screenshot */
#screenshotToolbar {
    display: none;
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 9999;
    background: rgba(255, 255, 255, 0.95);
    padding: 10px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    border: 1px solid #e0e0e0;
    flex-direction: row;
    gap: 10px;
}

body.screenshot-mode #screenshotToolbar {
    display: flex;
}

.tool-btn {
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: transform 0.2s, background 0.2s;
}

.btn-exit { background: #ffebee; color: #d32f2f; }
.btn-exit:hover { background: #ffcdd2; }

.btn-download { background: #e3f2fd; color: #1976d2; }
.btn-download:hover { background: #bbdefb; }

.btn-download-pdf { background: #fff3e0; color: #e65100; }
.btn-download-pdf:hover { background: #ffe0b2; }

.btn-copy { background: #e8f5e9; color: #388e3c; }
.btn-copy:hover { background: #c8e6c9; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>

    <!-- BARRA FLOTANTE DE HERRAMIENTAS (Solo visible en modo captura) -->
    <div id="screenshotToolbar">
        <button class="tool-btn btn-exit" onclick="toggleScreenshotMode()">
            Exit
        </button>
        <button class="tool-btn btn-download" onclick="captureDashboard('png')">
            Download PNG
        </button>
        <button class="tool-btn btn-download-pdf" onclick="captureDashboard('pdf')">
            Download PDF
        </button>
        <button class="tool-btn btn-copy" onclick="captureDashboard('copy')">
            Copy to Clipboard
        </button>
    </div>

    <div class="brand-header">
      <!-- Importante: crossorigin="anonymous" para permitir exportaci√≥n del canvas -->
      <img src="https://i.imgur.com/55NkFxP.png" alt="NIBU Logo" class="nibu-logo" crossorigin="anonymous">
      
      <!-- CONTENEDOR DE BOTONES DE CABECERA -->
      <div class="header-buttons">
          
          <!-- BOT√ìN SEMAFORO -->
          <button id="trafficToggle" onclick="toggleTrafficLight()" class="view-toggle-btn traffic-btn">
              üö¶ Traffic Light: OFF
          </button>

          <!-- A√ëADIDO: id y disabled para control JS -->
          <button id="screenshotBtn" onclick="toggleScreenshotMode()" class="view-toggle-btn screenshot-btn" disabled>
              üì∑ Screenshot view (Full View)
          </button>
          
          <button onclick="toggleView()" class="view-toggle-btn">
            üîÑ Change report: <span id="viewLabel" class="view-label">Report Full Year</span> 
          </button>
      </div>
    </div>

  <div class="wrapper">
    
    <!-- ============================== VISTA 1 ============================== -->
    <div id="vista1">
        <h1 id="mainTitle">Indicators by Country (Reporte Full Year)</h1> <!-- CAMBIA NOMBRE AQUI -->

        <div class="controls">
            <!-- INPUTS REMOVIDOS PARA CARGA AUTOM√ÅTICA -->
            <select id="countrySelect">
                <option value="">Select a Country</option>
            </select>
        </div>
        <div id="status"></div>

        <!-- MANUAL DE USUARIO RESTAURADO Y ACTUALIZADO -->
        <div id="instructionsBox" class="instructions-box">
            <div class="instructions-header">
                <svg class="instructions-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <h2>Quick Start Guide (Report Full Year)</h2>
            </div>
            
            <div class="instructions-content">
                <div class="instructions-grid">
                <div class="instruction-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                    <h3>Data Load (Auto)</h3>
                    <p>File loaded automatically: <br><strong>AP_OCT_A.xlsx</strong></p>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                    <h3>Check Status</h3>
                    <p>Ensure the status bar says <br>"‚úÖ Data loaded successfully"</p>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                    <h3>Select Country</h3>
                    <p>Choose a country from the dropdown to view specific metrics</p>
                    </div>
                </div>
                
                <div class="instruction-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                    <h3>Analyze Results</h3>
                    <p>Explore interactive charts and performance indicators</p>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="separacion hidden">
        <h1>Customer Experience</h1>
        </div>
        <div class="section">
        <div class="scroller" id="chartsRow1">
            
            <div class="card hidden" id="csiChartCard">
            <canvas id="csiGauge"></canvas>
            <p id="csiInfo"></p>
            <p>Target: <span id="csiTargetLabel"></span></p>
            </div>

            <div class="card hidden" id="ssiChartCard">
            <canvas id="ssiGauge"></canvas>
            <p id="ssiInfo"></p>
            <p>Target: <span id="ssiTargetLabel"></span></p>
            </div>

            <div class="card hidden" id="scChartCard">
            <canvas id="scGauge"></canvas>
            <p id="scInfo"></p>
            <p>Target: <span id="scTargetLabel"></span></p>
            </div>

            <div class="card hidden" id="trelChartCard">
            <canvas id="trelGauge"></canvas>
            <p id="trelInfo"></p>
            <p>Target: <span id="trelTargetLabel"></span></p>
            </div>

            <div class="card hidden" id="trainingCombinedBarChartCard">
            <canvas id="trainingCombinedBarChart"></canvas>
            </div>
            

            <div class="table-container hidden" id="nrcTableCard">
            <table class="info-table">
                <thead>
                <tr><th colspan="2">NRC Implementation</th></tr>
                <tr class="subheader"><td>Target</td><td>Status</td></tr>
                </thead>
                <tbody>
                <tr><td id="nrcTargetCell"></td><td id="nrcStatusCell"></td></tr>
                <!-- Fila para la mini gr√°fica -->
                <tr><td id="nrcExtraTargetCell"></td><td id="nrcExtraStatusCell"></td></tr>
                </tbody>
            </table>
            </div>

        </div>
        </div>

        <div class="separacion hidden">
        <h1>Brand Power</h1>
        </div>
        <!--ESTA ES LA SECCION DE LAS TABLAS-->
        <div class="section tables tables-container"> 

        <div class="table-container hidden" id="leadTableCard">
            <table class="info-table">
            <thead>
                <tr><th colspan="2">Lead Management</th></tr>
                <tr class="subheader"><td>Target</td><td>Status</td></tr>
            </thead>
            <tbody>
                <tr><td id="leadTargetCell"></td><td id="leadRealCell"></td></tr>
            </tbody>
            </table>
        </div>

        <div class="table-container hidden" id="shareTableCard">
            <table class="info-table">
            <thead>
                <tr><th colspan="2">Share of Investment</th></tr>
                <tr class="subheader"><td>Target</td><td>Status</td></tr>
                
            </thead>
            <tbody>
                <tr><td id="shareTargetCell"></td><td id="shareRealCell"></td></tr>
            </tbody>
            </table>
        </div>

        <!-- USAMOS LA TABLA PARA MOSTRAR EL BAR DE CUARTOS -->
        <div class="table-container hidden" id="gameplanTableCard">
            <table class="info-table">
            <thead>
                <tr><th colspan="2">GamePlan 360</th></tr>
                <tr class="subheader"><td>Target</td><td>Status</td></tr>
            </thead>
            <tbody>
                <tr><td id="gameplanTargetCell"></td><td id="gameplanRealCell"></td></tr>
            </tbody>
            </table>
        </div>
        
        </div>

        <div class="contenedor-total">
        <div class="section-block">
            <div class="scroller graficas-scroll">

            <div class="subgrupo">
                <div class="separacion titulo-grupo">
                <h1>Sustainable Growth</h1>
                </div>
                <div class="graficas-linea">
                <div class="card hidden" id="sellInChartCard">
                    <canvas id="sellInGauge"></canvas>
                    <p id="sellInInfo"></p>
                    <p>Target: <span id="sellInTargetLabel"></span></p>
                </div>
                <div class="card hidden" id="retentionChartCard">
                    <canvas id="retentionGauge"></canvas>
                    <p id="retentionInfo"></p>
                    <p>Target: <span id="retentionTargetLabel"></span></p>
                </div>
                <div class="card hidden" id="retailChartCard">
                    <canvas id="retailGauge"></canvas>
                    <p id="retailInfo"></p>
                    <p>Target: <span id="retailTargetLabel"></span></p>
                </div>
                </div>
            </div>

            <div class="subgrupo">
                <div class="separacion titulo-grupo">
                <h1>Total Achievement</h1>
                </div>
                <div class="graficas-linea">
                <div class="card hidden" id="totalChartCard">
                    <canvas id="totalGauge"></canvas>
                    <p id="totalInfo"></p>
                    <p>Target: <span id="totalTargetLabel">100%</span></p>
                </div>
                </div>
            </div>

            </div>
        </div>
        </div>

        <div id="debugInfo" class="hidden"></div>
    </div>

    <!-- ============================== VISTA 2 (COPIA EXACTA CON SUFIJOS _V2) ============================== -->
    <div id="vista2" class="hidden">
        <h1 id="mainTitle_V2">Indicators by Country (Report Year To Date)</h1> <!-- CAMBIA NOMBRE AQUI -->

        <div class="controls">
            <!-- INPUTS REMOVIDOS PARA CARGA AUTOM√ÅTICA -->
            <select id="countrySelect_V2">
                <option value="">Select a Country</option>
            </select>
        </div>
        <div id="status_V2"></div>

        <!-- MANUAL DE USUARIO RESTAURADO Y ACTUALIZADO V2 -->
        <div id="instructionsBox_V2" class="instructions-box">
            <div class="instructions-header">
                <svg class="instructions-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <h2>Quick Start Guide (Year To date)</h2>
            </div>
            
            <div class="instructions-content">
                <div class="instructions-grid">
                <div class="instruction-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                    <h3>Data Load (Auto)</h3>
                    <p>File loaded automatically: <br><strong>Annual_V2.xlsx</strong></p>
                    </div>
                </div>
                <div class="instruction-step"><div class="step-number">2</div><div class="step-content"><h3>Check Status</h3><p>Verify "Year To Date Report loaded"</p></div></div>
                <div class="instruction-step"><div class="step-number">3</div><div class="step-content"><h3>Select Country</h3><p>Select a country from the dropdown menu</p></div></div>
                <div class="instruction-step"><div class="step-number">4</div><div class="step-content"><h3>Analyze</h3><p>View Year To date KPI¬¥s</p></div></div>
                </div>
            </div>
        </div>

        <div class="separacion hidden separacion_V2">
            <h1>Customer Experience</h1>
        </div>
        <div class="section">
            <div class="scroller" id="chartsRow1_V2">
                
                <div class="card hidden" id="csiChartCard_V2">
                <canvas id="csiGauge_V2"></canvas>
                <p id="csiInfo_V2"></p>
                <p>Target: <span id="csiTargetLabel_V2"></span></p>
                </div>

                <div class="card hidden" id="ssiChartCard_V2">
                <canvas id="ssiGauge_V2"></canvas>
                <p id="ssiInfo_V2"></p>
                <p>Target: <span id="ssiTargetLabel_V2"></span></p>
                </div>

                <div class="card hidden" id="scChartCard_V2">
                <canvas id="scGauge_V2"></canvas>
                <p id="scInfo_V2"></p>
                <p>Target: <span id="scTargetLabel_V2"></span></p>
                </div>

                <div class="card hidden" id="trelChartCard_V2">
                <canvas id="trelGauge_V2"></canvas>
                <p id="trelInfo_V2"></p>
                <p>Target: <span id="trelTargetLabel_V2"></span></p>
                </div>

                <!-- ELIMINADA GRAFICA TRAINING BAR CHART EN V2 -->
                

                <div class="table-container hidden" id="nrcTableCard_V2">
                <table class="info-table">
                    <thead>
                    <tr><th colspan="2">NRC Implementation</th></tr>
                    <tr class="subheader"><td>Target</td><td>Status</td></tr>
                    </thead>
                    <tbody>
                    <tr><td id="nrcTargetCell_V2"></td><td id="nrcStatusCell_V2"></td></tr>
                    <!-- Fila para la mini gr√°fica -->
                    <tr><td id="nrcExtraTargetCell_V2"></td><td id="nrcExtraStatusCell_V2"></td></tr>
                    </tbody>
                </table>
                </div>

            </div>
        </div>

        <div class="separacion hidden separacion_V2">
            <h1>Brand Power</h1>
        </div>
        
        <div class="section tables tables-container"> 

            <div class="table-container hidden" id="leadTableCard_V2">
                <table class="info-table">
                <thead>
                    <tr><th colspan="2">Lead Management</th></tr>
                    <tr class="subheader"><td>Target</td><td>Status</td></tr>
                </thead>
                <tbody>
                    <tr><td id="leadTargetCell_V2"></td><td id="leadRealCell_V2"></td></tr>
                </tbody>
                </table>
            </div>

            <div class="table-container hidden" id="shareTableCard_V2">
                <table class="info-table">
                <thead>
                    <tr><th colspan="2">Share of Investment</th></tr>
                    <tr class="subheader"><td>Target</td><td>Status</td></tr>
                </thead>
                <tbody>
                    <tr><td id="shareTargetCell_V2"></td><td id="shareRealCell_V2"></td></tr>
                </tbody>
                </table>
            </div>

            <!-- USAMOS LA TABLA PARA MOSTRAR EL BAR DE CUARTOS -->
            <div class="table-container hidden" id="gameplanTableCard_V2">
                <table class="info-table">
                <thead>
                    <tr><th colspan="2">GamePlan 360</th></tr>
                    <tr class="subheader"><td>Target</td><td>Status</td></tr>
                </thead>
                <tbody>
                    <tr><td id="gameplanTargetCell_V2"></td><td id="gameplanRealCell_V2"></td></tr>
                </tbody>
                </table>
            </div>

        </div>

        <div class="contenedor-total">
            <div class="section-block">
                <div class="scroller graficas-scroll">

                <div class="subgrupo">
                    <div class="separacion titulo-grupo separacion_V2">
                    <h1>Sustainable Growth</h1>
                    </div>
                    <div class="graficas-linea">
                    <div class="card hidden" id="sellInChartCard_V2">
                        <canvas id="sellInGauge_V2"></canvas>
                        <p id="sellInInfo_V2"></p>
                        <p>Target: <span id="sellInTargetLabel_V2"></span></p>
                    </div>
                    <div class="card hidden" id="retentionChartCard_V2">
                        <canvas id="retentionGauge_V2"></canvas>
                        <p id="retentionInfo_V2"></p>
                        <p>Target: <span id="retentionTargetLabel_V2"></span></p>
                    </div>
                    <div class="card hidden" id="retailChartCard_V2">
                        <canvas id="retailGauge_V2"></canvas>
                        <p id="retailInfo_V2"></p>
                        <p>Target: <span id="retailTargetLabel_V2"></span></p>
                    </div>
                    </div>
                </div>

                <div class="subgrupo">
                    <div class="separacion titulo-grupo separacion_V2">
                    <h1>Total Achievement</h1>
                    </div>
                    <div class="graficas-linea">
                    <div class="card hidden" id="totalChartCard_V2">
                        <canvas id="totalGauge_V2"></canvas>
                        <p id="totalInfo_V2"></p>
                        <p>Target: <span id="totalTargetLabel_V2">100%</span></p>
                    </div>
                    </div>
                </div>

                </div>
            </div>
        </div>

        <div id="debugInfo_V2" class="hidden"></div>
    </div>
    <!-- ============================== FIN VISTA 2 ============================== -->

  </div>

  <script>
// ====================== ARCHIVOS DE CARGA AUTOM√ÅTICA ======================
const FILE_PATHS = {
    V1: 'AP_OCT_A.xlsx',
    V2: 'Annual_V2.xlsx'
};

// ====================== CONFIGURACI√ìN DE VALIDACI√ìN DE KPIs ======================
// Define los nombres de columnas esperados y sus posiciones para cada vista
const KPI_VALIDATION = {
    V1: {
        // Columna √≠ndice: nombre esperado (basado en estructura del Excel)
        1: 'Market',
        2: 'CSI Target',
        3: 'CSI',
        6: 'SSI Target',
        7: 'SSI',
        10: 'NRC Target',
        11: 'NRC Status',
        15: 'Training',
        16: 'Training Target',
        18: 'SC Target',
        19: 'SC',
        22: 'Lead Target',
        23: 'Lead Real',
        26: 'Share',
        28: 'GamePlan',
        31: 'Sell-In Target',
        32: 'Sell-In',
        35: 'Retention Target',
        36: 'Retention',
        39: 'Retail Target',
        40: 'Retail',
        55: 'Total Achievement'
    },
    V2: {
        1: 'Market',
        2: 'CSI',
        3: 'SSI',
        5: 'Training',
        7: 'Lead',
        8: 'Share',
        9: 'GamePlan',
        12: 'Retail',
        13: 'Total',
        14: 'CSI Target',
        15: 'SSI Target',
        17: 'Retention Target',
        18: 'Retention',
        19: 'Sell-In Target',
        20: 'Sell-In',
        21: 'SC Target',
        22: 'SC'
    }
};

/**
 * Valida los encabezados del Excel contra los nombres esperados de KPIs
 * @param {Array} headerRow - Fila de encabezados del Excel
 * @param {string} version - 'V1' o 'V2'
 * @returns {Object} - {isValid: boolean, warnings: string[], errors: string[]}
 */
function validateKPIHeaders(headerRow, version) {
    const expectedHeaders = KPI_VALIDATION[version];
    const result = {
        isValid: true,
        warnings: [],
        errors: [],
        matched: [],
        mismatched: []
    };
    
    if (!headerRow || headerRow.length === 0) {
        result.isValid = false;
        result.errors.push('No header row found in Excel file');
        return result;
    }
    
    // Verificar cada columna esperada
    for (const [indexStr, expectedName] of Object.entries(expectedHeaders)) {
        const index = parseInt(indexStr);
        const actualValue = headerRow[index];
        
        if (actualValue === undefined || actualValue === null || actualValue === '') {
            result.warnings.push(`Column ${index}: Expected "${expectedName}" but found empty cell`);
            result.mismatched.push({ index, expected: expectedName, actual: '(empty)' });
        } else {
            // Normalizar para comparaci√≥n (quitar espacios, lowercase)
            const normalizedExpected = String(expectedName).toLowerCase().trim();
            const normalizedActual = String(actualValue).toLowerCase().trim();
            
            // Verificar si contiene el nombre esperado (b√∫squeda flexible)
            if (normalizedActual.includes(normalizedExpected) || normalizedExpected.includes(normalizedActual)) {
                result.matched.push({ index, expected: expectedName, actual: actualValue });
            } else {
                result.warnings.push(`Column ${index}: Expected "${expectedName}" but found "${actualValue}"`);
                result.mismatched.push({ index, expected: expectedName, actual: actualValue });
            }
        }
    }
    
    // Si hay m√°s del 50% de discrepancias, marcar como inv√°lido
    const totalChecked = Object.keys(expectedHeaders).length;
    if (result.mismatched.length > totalChecked * 0.5) {
        result.isValid = false;
        result.errors.push(`Too many column mismatches (${result.mismatched.length}/${totalChecked}). Please verify the Excel structure.`);
    }
    
    return result;
}

/**
 * Muestra los resultados de validaci√≥n en la consola y opcionalmente en pantalla
 */
function displayValidationResults(result, version, showAlert = false) {
    const prefix = `[KPI Validation ${version}]`;
    
    console.group(prefix);
    
    if (result.matched.length > 0) {
        console.log('%c‚úÖ Matched columns:', 'color: green; font-weight: bold');
        result.matched.forEach(m => console.log(`  Column ${m.index}: "${m.expected}" ‚úì`));
    }
    
    if (result.warnings.length > 0) {
        console.warn('%c‚ö†Ô∏è Warnings:', 'color: orange; font-weight: bold');
        result.warnings.forEach(w => console.warn(`  ${w}`));
    }
    
    if (result.errors.length > 0) {
        console.error('%c‚ùå Errors:', 'color: red; font-weight: bold');
        result.errors.forEach(e => console.error(`  ${e}`));
    }
    
    console.log(`%cSummary: ${result.matched.length} matched, ${result.mismatched.length} mismatched`, 
        result.isValid ? 'color: green' : 'color: red');
    
    console.groupEnd();
    
    // Mostrar alerta si hay problemas significativos
    if (showAlert && !result.isValid) {
        
    }
    
    return result;
}

// ====================== CONTROL DE SEM√ÅFORO GLOBAL ======================
let isTrafficLightOn = false; // Por defecto apagado (Azul)

function toggleTrafficLight() {
    isTrafficLightOn = !isTrafficLightOn;
    const btn = document.getElementById('trafficToggle');
    if (btn) {
        if (isTrafficLightOn) {
            btn.classList.add('active');
            btn.textContent = "üö¶ Traffic Light: ON";
        } else {
            btn.classList.remove('active');
            btn.textContent = "üö¶ Traffic Light: OFF";
        }
    }

    // Re-renderizar la vista actual si hay datos cargados
    const v1Visible = !document.getElementById('vista1').classList.contains('hidden');
    
    if (v1Visible && stateV1.data.length > 0) {
        const countrySelect = document.getElementById('countrySelect');
        if (countrySelect.value) {
            const countryData = stateV1.data.find(d => d.country === countrySelect.value);
            if (countryData) renderDashboard(countryData, stateV1, '');
        }
    } else if (!v1Visible && stateV2.data.length > 0) {
        const countrySelectV2 = document.getElementById('countrySelect_V2');
        if (countrySelectV2.value) {
            const countryData = stateV2.data.find(d => d.country === countrySelectV2.value);
            if (countryData) renderDashboard(countryData, stateV2, '_V2');
        }
    }
}

// ====================== FUNCI√ìN MODO CAPTURA Y EXPORTACI√ìN ======================
function toggleScreenshotMode() {
    document.body.classList.toggle('screenshot-mode');
    // Forzar redibujado
    window.dispatchEvent(new Event('resize'));
    //una vez cerrado quitar el menu de exit 
    const toolbar = document.getElementById('screenshotToolbar');
    if (!document.body.classList.contains('screenshot-mode')) {
        toolbar.style.display = 'none';

    }
    else {
        toolbar.style.display = 'flex';
    }
}

async function captureDashboard(action) {
    // 1. Ocultar la barra de herramientas para que no salga en la foto
    const toolbar = document.getElementById('screenshotToolbar');
    toolbar.style.display = 'none';

    // 2. Scroll al inicio para evitar cortes
    window.scrollTo(0, 0);

    try {
        // 3. Seleccionar el elemento a capturar (wrapper principal)
        const element = document.querySelector('.wrapper');
        
        // Esperar un momento para asegurar que los estilos se aplicaron
        await new Promise(resolve => setTimeout(resolve, 300));

        // 4. DETECCI√ìN INTELIGENTE DE ANCHO (M√ìVIL VS ESCRITORIO)
        // Si estamos en m√≥vil (< 768px), usamos el ancho de la ventana para una captura vertical.
        // Si estamos en escritorio, forzamos los 1200px del dise√±o de 3 columnas.
        const isMobile = window.innerWidth <= 768;
        const captureWidth = isMobile ? window.innerWidth : 1200;

        // Generar el canvas con html2canvas
        const canvas = await html2canvas(element, {
            scale: isMobile ? 2 : 3, // Escala ligeramente menor en m√≥vil para ahorrar memoria
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: captureWidth, // Ancho din√°mico
            windowWidth: captureWidth // Simular ancho de ventana correcto
        });

        const date = new Date().toISOString().slice(0,10);

        if (action === 'png') {
            // Descargar imagen PNG
            const link = document.createElement('a');
            link.download = `NIBU_Dashboard_${date}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        } else if (action === 'pdf') {
            // Descargar como PDF
            const { jsPDF } = window.jspdf;
            
            // Obtener dimensiones del canvas
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            
            // Calcular dimensiones del PDF (A4 landscape o portrait seg√∫n proporci√≥n)
            const pdfWidth = 297; // A4 landscape width en mm
            const pdfHeight = (imgHeight * pdfWidth) / imgWidth;
            
            // Crear PDF en orientaci√≥n landscape para mejor visualizaci√≥n del dashboard
            const pdf = new jsPDF({
                orientation: pdfHeight > pdfWidth ? 'portrait' : 'landscape',
                unit: 'mm',
                format: [pdfWidth, pdfHeight]
            });
            
            // Agregar la imagen al PDF
            const imgData = canvas.toDataURL('image/png');
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            
            // Descargar el PDF
            pdf.save(`NIBU_Dashboard_${date}.pdf`);
        } else if (action === 'copy') {
            // Copiar al portapapeles
            canvas.toBlob(blob => {
                const item = new ClipboardItem({ 'image/png': blob });
                navigator.clipboard.write([item]).then(() => {
                    alert('‚úÖ Image copied to clipboard!');
                }).catch(err => {
                    console.error('Error copying:', err);
                    alert('‚ùå Failed to copy. Check permissions.');
                });
            });
        }

    } catch (error) {
        console.error('Capture error:', error);
        alert('‚ùå Error generating capture.');
    } finally {
        // 5. Restaurar la barra de herramientas
        toolbar.style.display = 'flex';
    }
}
// =================================================================

// ====================== CONSTANTES DE NOMBRES (EDITA AQUI) ======================
const VIEW_CONFIG = {
    NAME_V1: "Report:  Full Year", // Nombre completo para Vista 1
    NAME_V2: "Report:  Year To Date"        // Nombre completo para Vista 2
};
// ===============================================================================

const CONFIG = {
  SHEET_NAME: 'Data',
  SHEET_NAME_V2: 'Sheet1', // Hoja para Vista 2
  MAX_ROWS: 50,
  // IDs for View 1
  CHART_IDS_V1: [
    'csiChartCard', 'ssiChartCard', 'scChartCard', 'trelChartCard',
    'trainingCombinedBarChartCard',
    'sellInChartCard', 'retentionChartCard', 'retailChartCard', 'totalChartCard',
    'nrcTableCard', 'leadTableCard', 'shareTableCard', 'gameplanTableCard' // gameplanBatteryCard REMOVED
  ],
  // IDs for View 2 - REMOVIDO trainingCombinedBarChartCard_V2
  CHART_IDS_V2: [
    'csiChartCard_V2', 'ssiChartCard_V2', 'scChartCard_V2', 'trelChartCard_V2',
    'sellInChartCard_V2', 'retentionChartCard_V2', 'retailChartCard_V2', 'totalChartCard_V2',
    'nrcTableCard_V2', 'leadTableCard_V2', 'shareTableCard_V2', 'gameplanTableCard_V2' // gameplanBatteryCard_V2 REMOVED
  ],
  // Colores para escalas V2
  SCALE_COLORS_V2: {
    critical: '#b71c1c', // < 90% (Rojo Oscuro/Rojo)
    bad: '#f44336',      // < 90% (Rojo Est√°ndar)
    warning: '#FFC107',  // 90% - 94% (Amarillo)
    good: '#4CAF50',     // >= 95% (Verde)
    gray: '#e0e0e0'
  },
  // Color Azul fijo para Vista 1
  COLOR_V1_FILL: '#1976D2', // Azul
  // Mantengo estos por compatibilidad si se usan directo
  COLORS: {
    success: '#4caf50',
    warning: '#ffc107',
    danger: '#f44336',
    special: '#11ce30ff',
    training: '#b0b0b0',
    target: '#c62828',
    gray: '#e0e0e0'
  }
};

const formatters = {
  percent: (v) => isNaN(v) ? 'NA' : `${v.toFixed(1)}%`,
  intPercent: (v) => isNaN(v) ? 'NA' : `${Math.round(v)}%`,
  currency: (v) => {
    if (isNaN(v)) return 'NA';
    try {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      }).format(v);
    } catch (e) {
      return `${v.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
    }
  },
  // NUEVO FORMATO: Porcentaje con 1 decimal
  percent_1_decimal: (v) => isNaN(v) ? 'NA' : `${v.toFixed(1)}%`,
  // NUEVO FORMATO: Unidad con 1 decimal
  unity_1_decimal: (v) => isNaN(v) || v <= 0 ? 'NA' : v.toFixed(1),
  // NUEVO FORMATO: Millones con 1 decimal
  millions_1_decimal: (v) => isNaN(v) || v <= 0 
    ? 'NA' 
    : `${(v / 1_000_000).toFixed(1)} M`
};

// ESTADO SEPARADO
const stateV1 = {
  data: [],
  charts: {
    csi: null, ssi: null, sc: null, trel: null,
    trainingCombined: null,
    sellIn: null, retention: null, retail: null, total: null,
    gameplanBattery: null // Mantenemos la referencia, aunque ya no es Chart.js
  },
  loadedFile: null
};

const stateV2 = {
  data: [],
  charts: {
    csi: null, ssi: null, sc: null, trel: null,
    trainingCombined: null,
    sellIn: null, retention: null, retail: null, total: null,
    gameplanBattery: null // Mantenemos la referencia, aunque ya no es Chart.js
  },
  loadedFile: null
};

// Logic for View Toggling
function toggleView() {
  const v1 = document.getElementById("vista1");
  const v2 = document.getElementById("vista2");
  const label = document.getElementById("viewLabel");

  if (v1.classList.contains("hidden")) {
    v1.classList.remove("hidden");
    v2.classList.add("hidden");
    label.textContent = VIEW_CONFIG.NAME_V1; // Usa nombre configurado
  } else {
    v1.classList.add("hidden");
    v2.classList.remove("hidden");
    label.textContent = VIEW_CONFIG.NAME_V2; // Usa nombre configurado
  }
  // Re-renderizar si es necesario para aplicar sem√°foro correctamente
  toggleTrafficLight(); // Esto refresca la vista
  // Pero como toggleTrafficLight invierte el estado, necesitamos restaurarlo
  isTrafficLightOn = !isTrafficLightOn; 
  // Mejor llamar a un refresh manual o confiar en que los datos ya est√°n renderizados
}

function mapRowToData(row) {
  // === L√≥gica nueva para NRC Implementation ===
  let processedNrc = "NA"; // Valor por defecto
  const rawNrc = row[11];
  
  if (rawNrc !== undefined && rawNrc !== null) {
      // Convertir a string y limpiar espacios
      const strNrc = String(rawNrc).trim();
      // Si no es cadena vac√≠a y no es un guion, usamos el valor real
      if (strNrc !== "" && strNrc !== "-") {
          processedNrc = strNrc;
      }
  }
  // ============================================

  return {
    country: String(row[1]).trim(),
    csi: parseFloat(row[3]) * 100,
    csi_target: parseFloat(row[2]) * 100,
    ssi: parseFloat(row[7]) * 100,
    ssi_target: parseFloat(row[6]) * 100,
    SC: parseFloat(row[19]) * 100,
    SC_target: parseFloat(row[18]) * 100,
    TREL: parseFloat(row[15]) * 100,
    TREL_target: parseFloat(row[16]) * 100,
    nrcStatus: processedNrc, // Usamos la variable procesada
    nrcTarget: String(row[10] || '').trim(),
    nrcProgress: (parseFloat(row[56]) || 0) * 100, // <--- CAMBIA EL INDICE [12] POR LA COLUMNA DE PROGRESO NRC EN EXCEL V1
    leadTarget: String(row[22] || '').trim(),
    // Aseguramos que los datos Lead/Share/GamePlan sean porcentajes v√°lidos para la barra de progreso
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    leadReal: row[23] !== '' && !isNaN(row[23])  
      ? `${(parseFloat(row[23]) * 100).toFixed(1)}%` 
      : 'NA',
    shareTarget: 'Top 5 Competitors + Nissan',
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    shareReal: row[26] !== '' && !isNaN(row[26]) 
      ? `${(parseFloat(row[26]) * 100).toFixed(1)}%` 
      : 'NA',
    gameplanTarget: 'Quarterly Template Format',
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    gameplanReal: row[28] !== '' && !isNaN(row[28]) 
      ? `${(parseFloat(row[28]) * 100).toFixed(1)}%` 
      : 'NA',
    // CAMBIO: Quitar || 0 para permitir NaN si est√° vac√≠o
    sellIn: parseFloat(row[32]), 
    sellInTarget: parseFloat(row[31]),
    retention: parseFloat(row[36]),
    retentionTarget: parseFloat(row[35]),
    retailSales: parseFloat(row[40]),
    retailSalesTarget: parseFloat(row[39]),
    totalAchievement: parseFloat(row[55]) * 100,
    realTRsales: (parseFloat(row[48]) || 0) * 100,
    realTRAftersales: (parseFloat(row[52]) || 0) * 100,
    TRsales: (parseFloat(row[47]) || 0) * 100,
    TRAftersales: (parseFloat(row[51]) || 0) * 100
  };
}
// AQUI SE LEEN LOS DATOS DE LOS EXCELS PARA VISTA 2
// NEW: Mapeo espec√≠fico para Vista 2 (Basado en Sheet1.csv)
function mapRowToDataV2(row) {

  // Validar que la fila tenga datos y no sea cabecera

  if (!row[3] || row[3] === 'Market') return null;



  return {

    // √çndices basados en el CSV proporcionado:

    // Col D (3): Market, Col E (4): CSI...

    country: String(row[1]).trim(),

    

    // Como el dato viene en % Cumplimiento (ej: 1.03), lo multiplicamos por 100

    // y fijamos el Target en 100 para que el Gauge pinte correctamente.
    
    // CAMBIO: Quitar || 0 para permitir NaN si est√° vac√≠o
    csi: parseFloat(row[2]) * 100,

    csi_target: parseFloat(row[14]) * 100,

    

    ssi: parseFloat(row[3]) * 100,

    ssi_target: parseFloat(row[15]) * 100,

    

    //nrcStatus: (parseFloat(row[4]) * 100).toFixed(0) + '%',
    nrcStatus : 'Signed',
    nrcTarget: 'NRC Plan',
    nrcProgress: (parseFloat(row[23]) || 0) * 100, // <--- CAMBIA EL INDICE [4] POR LA COLUMNA DE PROGRESO NRC EN EXCEL V2

    

    // Solo hay una columna Training, la asignamos a TREL

    TREL: parseFloat(row[5]) * 100,

    TREL_target: 90,

    

    SC: parseFloat(row[22]) * 100,

    SC_target: parseFloat(row[21]) * 100,

    
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    leadReal: row[7] !== '' && !isNaN(row[7]) 
      ? `${(parseFloat(row[7]) * 100).toFixed(1)}%` 
      : 'NA',

    leadTarget: '100%',

    
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    shareReal: row[8] !== '' && !isNaN(row[8]) 
      ? `${(parseFloat(row[8]) * 100).toFixed(1)}%` 
      : 'NA',

    shareTarget: '100%',

    
    // CAMBIO: Si est√° vac√≠o o no es n√∫mero, devuelve 'NA' en lugar de '0%'
    gameplanReal: row[9] !== '' && !isNaN(row[9]) 
      ? `${(parseFloat(row[9]) * 100).toFixed(1)}%` 
      : 'NA',

    gameplanTarget: '100%',

    //ESTO ES EL SELL IN



    sellIn: parseFloat(row[20]),

    sellInTarget: parseFloat(row[19]),

    

    retention: parseFloat(row[18]),

    retentionTarget: parseFloat(row[17]),

    

    retailSales: parseFloat(row[12]) * 100,

    retailSalesTarget: 100,

    

    totalAchievement: parseFloat(row[13]) * 100,

    
    // Datos faltantes descartados (en 0)
    realTRsales: 0, realTRAftersales: 0, TRsales: 0, TRAftersales: 0
  };
}

function restartFadeAnimations(suffix) {
    // suffix example: '' or '_V2'
  const selector = suffix === '_V2' 
    ? '#vista2 .card:not(.hidden), #vista2 .table-container:not(.hidden), #vista2 .separacion:not(.hidden)'
    : '#vista1 .card:not(.hidden), #vista1 .table-container:not(.hidden), #vista1 .separacion:not(.hidden)';

  const elements = document.querySelectorAll(selector);
  elements.forEach(el => {
    el.style.animation = 'none';
    void el.offsetHeight;
    el.style.animation = '';
  });
}

function createCombinedTrainingChart(realSales, targetSales, realAftersales, targetAftersales, canvasId, existingChart) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (existingChart) existingChart.destroy();

  // Detectar si estamos en modo screenshot para ajustar barras
  const isScreenshotMode = document.body.classList.contains('screenshot-mode');
  const barSizeReal = isScreenshotMode ? 18 : 30; // Barra real m√°s delgada
  const barSizeTarget = isScreenshotMode ? 6 : 8; // Barra target muy delgada

  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Sales', 'Aftersales'],
      datasets: [
        {
          label: 'Real (%)',
          data: [realSales, realAftersales],
          backgroundColor: ['#b0b0b0', '#a8a8a8'],
          borderWidth: 0,
          barThickness: barSizeReal,
          borderRadius: 3,
          order: 2 // Se dibuja primero (atr√°s)
        },
        {
          label: 'Target (%)',
          data: [targetSales, targetAftersales],
          backgroundColor: '#c62828',
          borderWidth: 0,
          barThickness: barSizeTarget,
          borderRadius: 2,
          order: 1 // Se dibuja despu√©s (adelante)
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      layout: {
        padding: {
          right: isScreenshotMode ? 80 : 20
        }
      },
      plugins: {
        legend: { display: !isScreenshotMode, position: 'bottom' },
        title: { display: true, text: 'Training e-Learning Completion', font: { size: isScreenshotMode ? 12 : 14, weight: 'bold' } }
      },
      scales: {
        x: {
          beginAtZero: true,
          max: 110,
          ticks: { 
            callback: (v) => `${v}%`,
            font: { size: isScreenshotMode ? 9 : 11 }
          },
          grid: { color: '#e0e0e0' }
        },
        y: { 
          grid: { display: false },
          ticks: {
            font: { size: isScreenshotMode ? 10 : 12 }
          }
        }
      }
    },
    plugins: [{
      id: 'trainingLabels',
      afterDatasetsDraw(chart, args, options) {
        if (!document.body.classList.contains('screenshot-mode')) return;

        const { ctx, data } = chart;
        
        const barDatasetIndex = 0; // Real
        const targetDatasetIndex = 1; // Target
        const barMeta = chart.getDatasetMeta(barDatasetIndex);
        const barDataset = data.datasets[barDatasetIndex];
        const targetDataset = data.datasets[targetDatasetIndex];

        ctx.save();
        
        barMeta.data.forEach((bar, index) => {
          const realValue = barDataset.data[index];
          const targetValue = targetDataset.data[index];
          
          const barStartX = bar.base;
          const barEndX = bar.x;
          const barCenterY = bar.y;
          const centerX = barStartX + (barEndX - barStartX) / 2;
          
          // Valor real - dentro de la barra, arriba
          ctx.font = 'bold 11px "Segoe UI", sans-serif';
          ctx.fillStyle = '#ffffff';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(realValue.toFixed(1) + '%', centerX, barCenterY - 7);
          
          // Target - dentro de la barra, abajo
          ctx.font = 'bold 10px "Segoe UI", sans-serif';
          ctx.fillStyle = '#c62828';
          ctx.fillText('Target(' + targetValue.toFixed(1) + '%)', centerX, barCenterY + 8);
        });
        
        ctx.restore();
      }
    }]
  });
}

/**
 * ACTUALIZADO: Crea una barra de progreso que refleja el porcentaje real (sin redondear a cuartos)
 * y muestra solo el valor del porcentaje real en la etiqueta.
 * @param {string} realValue El valor de cumplimiento (ej: '75.5%', '100.0%').
 * @param {string} cellId El ID de la celda.
 * @param {string} suffix Sufijo ('', '_V2').
 */
function drawQuarterBar(realValue, cellId, suffix) {
    const cell = document.getElementById(cellId);
    if (!cell) return;

    // 1. Parsear el valor de porcentaje a n√∫mero
    const value = parseFloat(realValue.replace('%', '')) || 0;
    
    // 2. Usar el valor real (limitado a 100%) para el ancho de la barra
    const fillPercentage = Math.min(100, Math.max(0, value));

    // 3. La clase de color ahora es unificada a AZUL para ambas vistas
    const fillColorClass = 'quarter-fill-v1'; // Color #105cd4 en CSS
    
    // 4. Creamos la visualizaci√≥n de la barra
    // La etiqueta solo muestra el valor del Excel (ej: '75.5%')
    const barHtml = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div class="quarter-bar-container">
                <div class="quarter-segment ${fillColorClass}" style="width: ${fillPercentage}%;"></div>
            </div>
            <div class="quarter-label">${realValue}</div>
        </div>
    `;

    // 5. Inyectar el HTML en la celda
    cell.innerHTML = barHtml;
}


async function loadExcelDataInternal(file, sheetName, mapperFn, startRow = 3, endRow = 50) {
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data, { type: 'array' });
  
  // Si no encuentra la hoja exacta, intenta usar la primera hoja disponible
  let targetSheet = sheetName;
  if (!workbook.SheetNames.includes(sheetName)) {
      console.warn(`Sheet '${sheetName}' not found. Using first sheet: ${workbook.SheetNames[0]}`);
      targetSheet = workbook.SheetNames[0];
  }
  
  const sheet = workbook.Sheets[targetSheet];
  const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
  
  const processedData = [];
  
  // Ajustamos los valores por defecto si no se pasan en la llamada (V1)
  const finalStartRow = startRow === 3 && arguments.length < 5 ? 3 : startRow;
  const finalEndRow = endRow === 50 && arguments.length < 5 ? 100 : endRow; // Aumentado a 100 para V1 si no se pasa

  // AQUI se itera sobre el rango de filas
  for (let i = finalStartRow; i < Math.min(finalEndRow, json.length); i++) {
    const row = json[i];
    if (!row || row.length < 3) continue; // Basic check
    
    const mapped = mapperFn(row);
    if (mapped) { // Only push if mapper returned valid object
        processedData.push(mapped);
    }
  }
  
  if (processedData.length === 0) {
    throw new Error('No valid data found in the sheet');
  }
  
  return processedData;
}

async function loadExcelFromURLInternal(url, sheetName, mapperFn, startRow = 3, endRow = 50, version = 'V1') {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`Download error (${response.status})`);
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    
    let targetSheet = sheetName;
    if (!workbook.SheetNames.includes(sheetName)) {
        targetSheet = workbook.SheetNames[0];
    }

    const sheet = workbook.Sheets[targetSheet];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
    
    // ===== VALIDACI√ìN DE ENCABEZADOS =====
    // Buscar la fila de encabezados (generalmente fila 0, 1 o 2)
    let headerRow = null;
    for (let i = 0; i < Math.min(3, json.length); i++) {
        if (json[i] && json[i].length > 5) {
            // Verificar si parece una fila de encabezados (contiene texto)
            const hasText = json[i].some(cell => typeof cell === 'string' && cell.length > 0);
            if (hasText) {
                headerRow = json[i];
                break;
            }
        }
    }
    
    if (headerRow) {
        const validationResult = validateKPIHeaders(headerRow, version);
        displayValidationResults(validationResult, version, !validationResult.isValid);
    } else {
        console.warn(`[KPI Validation ${version}] Could not find header row for validation`);
    }
    // =====================================
    
    const processedData = [];
    
    // Ajustamos los valores por defecto si no se pasan en la llamada (V1)
    const finalStartRow = startRow === 3 && arguments.length < 5 ? 3 : startRow;
    const finalEndRow = endRow === 50 && arguments.length < 5 ? 100 : endRow; // Aumentado a 100 para V1 si no se pasa
    
    // AQUI se itera sobre el rango de filas
    for (let i = finalStartRow; i < Math.min(finalEndRow, json.length); i++) {
      const row = json[i];
      if (!row || row.length < 3) continue;
      
      const mapped = mapperFn(row);
      if (mapped) processedData.push(mapped);
    }
    
    if (processedData.length === 0) throw new Error('No valid data found');
    return processedData;
  } catch (err) {
    throw new Error(`Could not read file from URL: ${err.message}`);
  }
}

function populateCountrySelector(targetState, selectId) {
  const select = document.getElementById(selectId);
  select.innerHTML = '<option value="">Select a Country</option>';
  
  targetState.data.forEach(d => {
    const option = document.createElement('option');
    option.value = d.country;
    option.textContent = d.country;
    select.appendChild(option);
  });
}

function calculateCompliance(value, target) {
  // CAMBIO: Si value es NaN, retorna NaN para detectar valores vac√≠os.
  if (isNaN(value)) return NaN;
  // Como en V2 ya viene el % cumplimiento como valor, y target es 100,
  // (value / 100) * 100 = value. Funciona igual para ambos casos.
  return target > 0 ? (value / target) * 100 : 0;
}

// NUEVA LOGICA DE COLORES GLOBAL (SEM√ÅFORO)
function getTrafficLightColor(compliance) {
  if (isNaN(compliance)) return CONFIG.COLORS.gray; // Gris para NaN
  if (compliance >= 95) return CONFIG.SCALE_COLORS_V2.good;        // >= 95% (Verde)
  if (compliance >= 90) return CONFIG.SCALE_COLORS_V2.warning;    // 90% - 94% (Amarillo)
  return CONFIG.SCALE_COLORS_V2.bad;                              // < 90% (Rojo)
}

const GAUGE_MODES = {
  // Modos originales (V1)
  percent: {
    getProgress: (value) => Math.max(0, Math.min(100, value)),
    formatValue: (value) => isNaN(value) ? 'NA' : `${value.toFixed(1)}%`,
    formatTarget: (target) => isNaN(target) ? 'NA' : `${target.toFixed(1)}%`
  },
  unity: {
    getProgress: (value, target) => target > 0 ? Math.min(100, (value/target)*100) : 0,
    // CAMBIO AQUI: Agregado toLocaleString para miles
    formatValue: (value) => isNaN(value) ? 'NA' : value.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }),
    formatTarget: (target) => isNaN(target) || target <= 0 ? 'NA' : target.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })
  },
  millions: {
    getProgress: (value, target) => target > 0 ? Math.min(100, (value/target)*100) : 0,
    formatValue: (value) => isNaN(value) ? 'NA' : `${(value / 1_000_000).toFixed(1)} M`,
    formatTarget: (target) => isNaN(target) || target <= 0 
      ? 'NA' 
      : `${(target / 1_000_000).toFixed(1)} M`
  },
  UnityNotDecimals: {
    getProgress: (value, target) => target > 0 ? Math.min(100, (value/target)*100) : 0,
    // CAMBIO AQUI: Agregado toLocaleString para miles sin decimales
    formatValue: (value) => isNaN(value) ? 'NA' : Math.round(value).toLocaleString('en-US'),
    formatTarget: (target) => isNaN(target) || target <= 0 ? 'NA' : Math.round(target).toLocaleString('en-US')
  },
  
  // Modos V2 (1 decimal solicitado)
  percent_1D: {
    getProgress: (value) => Math.max(0, Math.min(100, value)),
    formatValue: (value) => isNaN(value) ? 'NA' : `${value.toFixed(1)}%`, 
    formatTarget: (target) => isNaN(target) ? 'NA' : `${target.toFixed(1)}%`
  },
  unity_1D: {
    getProgress: (value, target) => target > 0 ? Math.min(100, (value/target)*100) : 0,
    // CAMBIO AQUI: Agregado toLocaleString para miles
    formatValue: (value) => isNaN(value) ? 'NA' : value.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 }), 
    formatTarget: (target) => isNaN(target) || target <= 0 ? 'NA' : target.toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 })
  },
  millions_1D: {
    getProgress: (value, target) => target > 0 ? Math.min(100, (value/target)*100) : 0,
    formatValue: (value) => isNaN(value) ? 'NA' : `${(value / 1_000_000).toFixed(1)} M`, 
    formatTarget: (target) => isNaN(target) || target <= 0 
      ? 'NA' 
      : `${(target / 1_000_000).toFixed(1)} M` 
  }
};

function drawGauge(options) {
  const {
    canvasId, label, value, target, cumplimiento, country,
    existingChart, infoId, targetId, mode = 'percent',
    specialColor = null, hideLabels = false, suffix = ''
  } = options;
  
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (existingChart) existingChart.destroy();
  
  const modeConfig = GAUGE_MODES[mode];
  // Calculo base para el progreso (que se usa para el llenado visual)
  // CAMBIO: Si cumplimiento es NaN, el progreso visual es 0 (vac√≠o)
  let progress = isNaN(cumplimiento) ? 0 : Math.min(100, Math.max(0, cumplimiento));

  const valueText = modeConfig.formatValue(value);
  const targetText = modeConfig.formatTarget(target);
  
  // L√≥gica de Color GLOBAL: Si Sem√°foro est√° ON, usa sem√°foro. Si OFF, usa Azul.
  let gaugeColor;
  
  // Si es NaN (vac√≠o), usar Gris siempre.
  if (isNaN(cumplimiento)) {
      gaugeColor = CONFIG.COLORS.gray;
  } else if (isTrafficLightOn) {
      // Modo Sem√°foro activado (Verde/Amarillo/Rojo)
      gaugeColor = getTrafficLightColor(cumplimiento);
  } else {
      // Modo Apagado (Azul por defecto)
      gaugeColor = CONFIG.COLOR_V1_FILL;
  }
  
  // Override si specialColor est√° forzado (aunque con la nueva regla, todo obedece al sem√°foro o al azul)
  // Dejamos esto solo si es estrictamente necesario, pero la regla global "traffic light on/off" domina.

  const remaining = Math.max(0, 100 - progress);
  
  const chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      datasets: [{
        data: [progress, remaining],
        backgroundColor: [gaugeColor, CONFIG.COLORS.gray],
        borderWidth: 0,
        circumference: 180,
        rotation: 270
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true },
        title: {
          display: true,
          text: `${label}`,
          font: { size: 16, weight: 'bold' }
        }
      }
    }
  });
  
  updateGaugeInfo(infoId, targetId, valueText, targetText, cumplimiento, gaugeColor, hideLabels, suffix);
  
  return chart;
}

/**
 * NUEVA FUNCI√ìN: Dibuja el gr√°fico de aguja peque√±o para NRC en el canvas provisto.
 */
function drawMiniGauge(canvasId, cumplimiento, suffix) {
    const canvasEl = document.getElementById(canvasId);
    if (!canvasEl) return;
    
    // Destruir cualquier instancia anterior
    if (canvasEl.chart) {
      canvasEl.chart.destroy();
    }

    const ctx = canvasEl.getContext('2d');
    
    // L√≥gica de Color Mini Gauge
    let gaugeColor;
    
    if (isTrafficLightOn) {
         // Modo Sem√°foro activado
         gaugeColor = getTrafficLightColor(cumplimiento);
    } else {
        // Modo Apagado (Azul)
        gaugeColor = CONFIG.COLOR_V1_FILL; 
    }

    const progress = Math.min(100, Math.max(0, cumplimiento));
    const remaining = Math.max(0, 100 - progress);

    const data = {
        datasets: [{
            data: [progress, remaining],
            backgroundColor: [gaugeColor, CONFIG.COLORS.gray],
            borderWidth: 0,
            circumference: 180,
            rotation: 270
        }]
    };

    const options = {
        responsive: false, 
        maintainAspectRatio: false,
        cutout: '70%', 
        plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
        },
        layout: { padding: 0 }
    };
    
    canvasEl.chart = new Chart(ctx, { type: 'doughnut', data, options });
}

function updateGaugeInfo(infoId, targetId, valueText, targetText, cumplimiento, color, hideLabels, suffix) {
  const infoEl = document.getElementById(infoId);
  
  // Usamos toFixed(1) para el porcentaje de cumplimiento
  const compText = isNaN(cumplimiento) ? 'NA' : `${cumplimiento.toFixed(1)}%`;
  
  // LOGICA DE INTERCAMBIO DE ETIQUETAS
  // "Para Total en ambas vistas y para Retail Sales en Vista 2: Fulfillment en lugar de Valor, y Valor en lugar de Fulfillment"
  // IDs afectados:
  const swappedIds = [
      'totalInfo',      // Total Vista 1
      'totalInfo_V2',   // Total Vista 2
      'retailInfo_V2'   // Retail Sales Vista 2
  ];

  // Si hideLabels es true (actualmente no usado)
  if (hideLabels) {
    infoEl.innerHTML = `<strong style="font-size: 22px; color:${color};">${valueText}</strong>`;
    document.getElementById(targetId).textContent = '';
    return;
  }

  // --- RENDERIZADO DEL HTML ---
  // La instrucci√≥n "valor de las gr√°ficas de la vista 1 se muestren en todo momento" se cumple aqu√≠,
  // ya que este HTML siempre es visible.
  
  if (swappedIds.includes(infoId)) {
      // MODO INVERTIDO SOLICITADO
      // - "Fulfillment" (como palabra) reemplaza al valor num√©rico (grande).
      // - El Valor num√©rico reemplaza a Fulfillment (peque√±o).
      // - Se quitan las etiquetas de texto "Value:" y "Fulfillment:".
      // - Se elimina el valor porcentual del texto de "Fulfillment" porque ya existe visualmente.
      
      infoEl.innerHTML = `
        <div style="margin-bottom:2px;">
            <strong style="font-size: 22px; color:${color};">Fulfillment</strong>
        </div>
        <div style="font-size: 13px; color: #555;">
            ${valueText}
        </div>
      `;
  } else {
      // MODO ESTANDAR (Resto de gr√°ficas y Retail V1)
      // Valor Absoluto Grande Arriba
      // Fulfillment Peque√±o Abajo
      infoEl.innerHTML = `
        <strong style="font-size: 22px; color:${color};">${valueText}</strong><br>
        <strong>Fulfillment:</strong> <span style="color:${color};">${compText}</span>
      `;
  }
  
  // Ocultar Target EXCLUSIVAMENTE para Retail Sales V2, Total Achievement V1 y Total Achievement V2
  const targetLabelElement = document.getElementById(targetId);
  const targetContainer = targetLabelElement ? targetLabelElement.parentElement : null;

  // Condici√≥n para ocultar el Target (V2 Retail, V1 Total, V2 Total)
  const shouldHideTarget = (targetId === 'retailTargetLabel_V2' || targetId === 'totalTargetLabel_V2' || targetId === 'totalTargetLabel');
  
  if (targetContainer) {
    targetContainer.style.display = 'block'; 
    
    if (shouldHideTarget) {
      // Target se oculta limpiando el HTML, pero manteniendo el contenedor
      targetContainer.innerHTML = '&nbsp;';
    } else {
      // Target se muestra con su valor normal (Esto incluye Service Campaign)
      targetContainer.innerHTML = `Target: <span id="${targetId}">${targetText}</span>`;
    }
  }
}

// CORREGIDA: Ahora inyecta el canvas y llama a drawMiniGauge con un peque√±o delay
function updateTable(targetId, statusId, targetValue, statusValue, suffix, nrcProgressValue) {
  document.getElementById(targetId).textContent = targetValue || '';
  document.getElementById(statusId).textContent = statusValue || '';
  
  // L√≥gica para la fila de mini-gr√°fica NRC
  const extraTargetCellId = 'nrcExtraTargetCell' + suffix;
  const extraStatusCellId = 'nrcExtraStatusCell' + suffix;
  const miniGaugeCanvasId = 'nrcMiniGauge' + suffix;

  // Actualizar la fila principal de la tabla NRC
  // No cambiamos esto ya que es donde se muestran los datos del Excel
  // document.getElementById('nrcExtraTargetCell' + suffix) ya tiene su texto.
  
  if (document.getElementById(extraTargetCellId)) {
      // 1. Actualizar Target con el label
      document.getElementById(extraTargetCellId).textContent = 'Progress execution'; 
      
      // 2. Configuramos valores para el mini-gr√°fico
      const cumplimiento = nrcProgressValue !== undefined ? nrcProgressValue : 0;
      // Usamos toFixed(1) para la mini gr√°fica
      const compText = `${cumplimiento.toFixed(1)}%`;
      
      // 3. Insertamos la estructura HTML (Canvas + Texto) en la celda de Status
      const statusCell = document.getElementById(extraStatusCellId);
      
      // Limpiamos y preparamos el HTML para la gr√°fica
      statusCell.innerHTML = '';

      // Inyectamos la estructura con el canvas y el texto
      statusCell.innerHTML = `
          <div class="mini-gauge-container">
              <canvas id="${miniGaugeCanvasId}" width="35" height="35"></canvas>
              <span class="mini-gauge-text" id="${miniGaugeCanvasId}_text">${compText}</span>
          </div>
      `;
      
      // 4. Dibujar el Mini Gauge en el Canvas reci√©n creado (usamos setTimeout para asegurar renderizado)
      setTimeout(() => {
           drawMiniGauge(miniGaugeCanvasId, cumplimiento, suffix);
           // Actualizar color del texto
           const textEl = document.getElementById(miniGaugeCanvasId + '_text');
           if(textEl) {
               let color;
               if (isTrafficLightOn) color = getTrafficLightColor(cumplimiento);
               else color = CONFIG.COLOR_V1_FILL;
               
               textEl.style.color = color;
           }
      }, 0);
  }
}

// Modified renderDashboard to accept suffix ('' or '_V2') and a state object
function renderDashboard(data, targetState, suffix) {
  let {
    country, csi, csi_target, ssi, ssi_target, SC, SC_target, TREL, TREL_target,
    nrcStatus, nrcTarget, nrcProgress, leadTarget, leadReal, shareTarget, shareReal,
    gameplanTarget, gameplanReal, sellIn, sellInTarget, retention, retentionTarget,
    retailSales, retailSalesTarget, totalAchievement,
    realTRsales, realTRAftersales, TRsales, TRAftersales
  } = data;
  
  // =========================================================================
  // ** MODIFICACI√ìN SOLICITADA: Sobrescribir TARGETS de Brand Power para VISTA 2 **
  // =========================================================================
  if (suffix === '_V2') {
      leadTarget = 'Monthly Report';
      shareTarget = 'Top 5 Competitors + Nissan';
      gameplanTarget = 'Quarterly Template Format';
      // En V2, el target NRC es 100%, pero lo mantenemos para ser consistente.
      // nrcTarget = '100%';
  }
  // =========================================================================
  
  // =========================================================================
  
  // =========================================================================
  // Nota: Todos los Targets/Valores V2 usan ahora el modo con 1 decimal (_1D), excepto RetailSales que no tiene target.
  let mode_csi = suffix === '_V2' ? 'percent_1D' : 'percent';
  let mode_ssi = suffix === '_V2' ? 'percent_1D' : 'percent';
  let mode_sc = suffix === '_V2' ? 'percent_1D' : 'percent';
  let mode_trel = suffix === '_V2' ? 'percent_1D' : 'percent';
  let mode_sellIn = suffix === '_V2' ? 'millions_1D' : 'millions';
  let mode_retention = suffix === '_V2' ? 'unity_1D' : 'unity';
  let mode_retail = suffix === '_V2' ? 'percent_1D' : 'UnityNotDecimals'; 
  //let mode_retail = 'UnityNotDecimals'; // Retail Sales siempre sin decimales en valor real
  let mode_total = suffix === '_V2' ? 'percent_1D' : 'percent';


  const mainTitle = document.getElementById('mainTitle' + suffix);
  if (mainTitle) {
    // USE CONFIGURED NAMES
    const viewName = suffix === '' ? VIEW_CONFIG.NAME_V1 : VIEW_CONFIG.NAME_V2;
    mainTitle.textContent = `Dashboard NIBU - ${country} (${viewName})`;
  }
  
  const compliance = {
    csi: calculateCompliance(csi, csi_target),
    ssi: calculateCompliance(ssi, ssi_target),
    sc: calculateCompliance(SC, SC_target),
    trel: calculateCompliance(TREL, TREL_target),
    sellIn: calculateCompliance(sellIn, sellInTarget),
    retention: calculateCompliance(retention, retentionTarget),
    retail: calculateCompliance(retailSales, retailSalesTarget)
  };
  
  targetState.charts.csi = drawGauge({
    canvasId: 'csiGauge' + suffix, label: 'CSI', value: csi, target: csi_target,
    cumplimiento: compliance.csi, country, existingChart: targetState.charts.csi,
    infoId: 'csiInfo' + suffix, targetId: 'csiTargetLabel' + suffix, mode: mode_csi, suffix
  });
  
  targetState.charts.ssi = drawGauge({
    canvasId: 'ssiGauge' + suffix, label: 'SSI', value: ssi, target: ssi_target,
    cumplimiento: compliance.ssi, country, existingChart: targetState.charts.ssi,
    infoId: 'ssiInfo' + suffix, targetId: 'ssiTargetLabel' + suffix, mode: mode_ssi, suffix
  });
  
  targetState.charts.sc = drawGauge({
    canvasId: 'scGauge' + suffix, label: 'Service Campaign', value: SC, target: SC_target,
    cumplimiento: compliance.sc, country, existingChart: targetState.charts.sc,
    infoId: 'scInfo' + suffix, targetId: 'scTargetLabel' + suffix, mode: mode_sc, suffix
  });
  
  targetState.charts.trel = drawGauge({
    canvasId: 'trelGauge' + suffix, label: 'Training',
    value: TREL, target: TREL_target, cumplimiento: compliance.trel,
    country, existingChart: targetState.charts.trel,
    infoId: 'trelInfo' + suffix, targetId: 'trelTargetLabel' + suffix, mode: mode_trel, suffix
  });
  
  // RENDERIZADO CONDICIONAL DE GRAFICA TRAINING
  if (suffix !== '_V2') {
      targetState.charts.trainingCombined = createCombinedTrainingChart(
        realTRsales, TRsales,
        realTRAftersales, TRAftersales,
        'trainingCombinedBarChart' + suffix,
        targetState.charts.trainingCombined
      );
  }
  
  targetState.charts.sellIn = drawGauge({
    canvasId: 'sellInGauge' + suffix, label: 'Sell-In', value: sellIn, target: sellInTarget,
    cumplimiento: compliance.sellIn, country, existingChart: targetState.charts.sellIn,
    infoId: 'sellInInfo' + suffix, targetId: 'sellInTargetLabel' + suffix, 
    mode: mode_sellIn, suffix
  });
  
  targetState.charts.retention = drawGauge({
    canvasId: 'retentionGauge' + suffix, label: 'Retention',
    value: retention, target: retentionTarget,
    cumplimiento: compliance.retention, country, existingChart: targetState.charts.retention,
    infoId: 'retentionInfo' + suffix, targetId: 'retentionTargetLabel' + suffix, mode: mode_retention, suffix
  });
  
  targetState.charts.retail = drawGauge({
    canvasId: 'retailGauge' + suffix, label: 'Retail Sales',
    value: retailSales, target: retailSalesTarget,
    cumplimiento: compliance.retail, country, existingChart: targetState.charts.retail,
    infoId: 'retailInfo' + suffix, targetId: 'retailTargetLabel' + suffix, 
    // Retail Sales V2 solo muestra el valor real con 1 decimal, Target se oculta en updateGaugeInfo
    mode: mode_retail, suffix
  });
  let totalValue = "";
  targetState.charts.total = drawGauge({
    canvasId: 'totalGauge' + suffix, label: 'Total',
    value: totalAchievement,
    cumplimiento: totalAchievement, country, existingChart: targetState.charts.total,
    infoId: 'totalInfo' + suffix, targetId: 'totalTargetLabel' + suffix,
    mode: mode_total, specialColor: null, suffix 
  });
  
  // Las tablas se actualizan con los posibles overrides de V2
  updateTable('nrcTargetCell' + suffix, 'nrcStatusCell' + suffix, nrcTarget, nrcStatus, suffix, nrcProgress);
  
  // Aplicar la barra de cuartos a Lead Management, Share of Investment y GamePlan 360
  
  // 1. Lead Management
  document.getElementById('leadTargetCell' + suffix).textContent = leadTarget;
  drawQuarterBar(leadReal, 'leadRealCell' + suffix, suffix);
  
  // 2. Share of Investment
  document.getElementById('shareTargetCell' + suffix).textContent = shareTarget;
  drawQuarterBar(shareReal, 'shareRealCell' + suffix, suffix);
  
  // 3. GamePlan 360
  document.getElementById('gameplanTargetCell' + suffix).textContent = gameplanTarget;
  drawQuarterBar(gameplanReal, 'gameplanRealCell' + suffix, suffix);
}

function toggleDashboardVisibility(show, suffix) {
  const CHART_IDS = suffix === '_V2' ? CONFIG.CHART_IDS_V2 : CONFIG.CHART_IDS_V1;
  
  CHART_IDS.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      if (show) {
        element.classList.remove('hidden');
      } else {
        element.classList.add('hidden');
      }
    }
  });
  
  // Manejo especial para las separaciones porque son clases, no IDs √∫nicos en V1
  // En V1 son .separacion (sin V2). En V2 tienen .separacion_V2
  const selector = suffix === '_V2' ? '.separacion.separacion_V2' : '.separacion:not(.separacion_V2)';
  document.querySelectorAll(selector).forEach(sec => {
    if (show) {
      sec.classList.remove('hidden');
      sec.style.display = 'flex';
    } else {
      sec.classList.add('hidden');
      sec.style.display = 'none';
    }
  });
  
  const instructionsBox = document.getElementById('instructionsBox' + suffix);
  if (instructionsBox) {
    if (show) {
      instructionsBox.classList.add('hidden');
    } else {
      instructionsBox.classList.remove('hidden');
    }
  }
}

function updateStatus(message, type = '', suffix = '') {
  const statusElement = document.getElementById('status' + suffix);
  if(statusElement) {
    statusElement.textContent = message;
    statusElement.className = type;
  }
}

// ----- NUEVA FUNCI√ìN DE CARGA AUTOM√ÅTICA -----

async function autoLoadData() {
    // 1. Cargar datos de Vista 1
    await loadView1();
    // 2. Cargar datos de Vista 2
    await loadView2();
}

async function loadView1() {
    updateStatus('‚è≥ Auto-loading data...', '', '');
    
    try {
        // Carga autom√°tica del archivo AP_OCT_A.xlsx
        stateV1.data = await loadExcelFromURLInternal(FILE_PATHS.V1, CONFIG.SHEET_NAME, mapRowToData, 3, 100, 'V1');
        updateStatus('‚úÖ Data loaded successfully.', '', '');
        
        populateCountrySelector(stateV1, 'countrySelect');
        
        // Agregar T√≠tulo de Periodo V1
        const statusDiv1 = document.getElementById('status');
        const existingTitle = statusDiv1.querySelector('h2');
        if (existingTitle) existingTitle.remove();
        
        const extraTitle1 = document.createElement('h2');
        extraTitle1.textContent = "Period: As Of October"; 
        extraTitle1.style.color = "#333"; 
        extraTitle1.style.marginTop = "10px";
        extraTitle1.style.fontSize = "16px"; 
        statusDiv1.appendChild(extraTitle1);

    } catch (err) {
        console.error('Error loading V1:', err);
        updateStatus(`‚ùå Load Error (${FILE_PATHS.V1}): ${err.message}`, 'error', '');
    }
}

async function loadView2() {
    updateStatus('‚è≥ Auto-loading data...', '', '_V2');
    
    try {
        // Carga autom√°tica del archivo Annual_V2.xlsx
        stateV2.data = await loadExcelFromURLInternal(FILE_PATHS.V2, CONFIG.SHEET_NAME_V2, mapRowToDataV2, 2, 17, 'V2');
        updateStatus('‚úÖ Year To Date Report loaded successfully.', '', '_V2');
        
        populateCountrySelector(stateV2, 'countrySelect_V2');
        
        // Agregar T√≠tulo de Periodo V2
        const statusDiv = document.getElementById('status_V2');
        const existingTitle = statusDiv.querySelector('h2');
        if (existingTitle) existingTitle.remove();

        const extraTitle = document.createElement('h2');
        extraTitle.textContent = "Period: April - September"; 
        extraTitle.style.color = "#333"; 
        extraTitle.style.marginTop = "10px";
        extraTitle.style.fontSize = "16px"; 
        statusDiv.appendChild(extraTitle);

    } catch (err) {
        console.error('Error loading V2:', err);
        updateStatus(`‚ùå Load Error (${FILE_PATHS.V2}): ${err.message}`, 'error', '_V2');
    }
}

function handleCountryChangeV1(e) {
  const country = e.target.value;
  const screenshotBtn = document.getElementById('screenshotBtn');
  
  if (!country) {
    toggleDashboardVisibility(false, '');
    const mainTitle = document.getElementById('mainTitle');
    if (mainTitle) {
      // USE CONFIGURED NAME
      mainTitle.textContent = `Indicators by Country (${VIEW_CONFIG.NAME_V1})`;
    }
    // Deshabilitar bot√≥n si no hay pa√≠s
    if(screenshotBtn) screenshotBtn.disabled = true;
    return;
  }
  
  const countryData = stateV1.data.find(d => d.country === country);
  
  if (!countryData) {
    updateStatus('‚ö†Ô∏è Country not found in data.', 'error', '');
    if(screenshotBtn) screenshotBtn.disabled = true;
    return;
  }
  
  toggleDashboardVisibility(true, '');
  renderDashboard(countryData, stateV1, '');
  restartFadeAnimations('');
  
  // Habilitar bot√≥n al seleccionar pa√≠s
  if(screenshotBtn) screenshotBtn.disabled = false;
}

function handleCountryChangeV2(e) {
  const country = e.target.value;
  const screenshotBtn = document.getElementById('screenshotBtn');
  
  if (!country) {
    toggleDashboardVisibility(false, '_V2');
    const mainTitle = document.getElementById('mainTitle_V2');
    if (mainTitle) {
      // USE CONFIGURED NAME
      mainTitle.textContent = `Indicators by Country (${VIEW_CONFIG.NAME_V2})`;
    }
    // Deshabilitar bot√≥n si no hay pa√≠s
    if(screenshotBtn) screenshotBtn.disabled = true;
    return;
  }
  
  const countryData = stateV2.data.find(d => d.country === country);
  
  if (!countryData) {
    updateStatus('‚ö†Ô∏è Country not found in data.', 'error', '_V2');
    if(screenshotBtn) screenshotBtn.disabled = true;
    return;
  }
  
  toggleDashboardVisibility(true, '_V2');
  renderDashboard(countryData, stateV2, '_V2');
  restartFadeAnimations('_V2');
  
  // Habilitar bot√≥n al seleccionar pa√≠s
  if(screenshotBtn) screenshotBtn.disabled = false;
}

function initEventListeners() {
  // Solo Listeners de Cambio de Pa√≠s (Inputs de archivo removidos)
  document.getElementById('countrySelect').addEventListener('change', handleCountryChangeV1);
  document.getElementById('countrySelect_V2').addEventListener('change', handleCountryChangeV2);
}

// Inicializaci√≥n
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      autoLoadData(); // Iniciar carga autom√°tica
  });
} else {
  initEventListeners();
  autoLoadData();
}
  </script>
</body>
</html>